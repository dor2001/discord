
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DOR BOT - Music Dashboard</title>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    label { display: inline-block; min-width: 120px; }
    select, input, button { padding: 6px; margin: 6px 0; }
    .row { margin-bottom: 10px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin: 10px 0; }
    .list { display: grid; gap: 8px; }
    .item { border:1px solid #eee; padding:10px; border-radius:8px; display:flex; gap:10px; align-items:center; }
    img.thumb { width: 90px; height: 60px; object-fit: cover; border-radius:6px; }
  </style>
</head>
<body>
  <h1>🎵 DOR BOT - לוח בקרה</h1>

  <div class="card">
    <div class="row">
      <label>שרת (Guild):</label>
      <select id="guilds"></select>
      <button id="refreshGuilds">רענון</button>
    </div>
    <div class="row">
      <label>ערוץ קול:</label>
      <select id="channels"></select>
      <button id="moveBtn">העבר לבוט</button>
      <label><input type="checkbox" id="lockChk"> נעילה</label>
      <button id="unlockBtn">שחרר נעילה</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>חיפוש YouTube:</label>
      <input id="q" placeholder="שם שיר / לינק">
      <button id="searchBtn">חפש</button>
    </div>
    <div class="list" id="results"></div>
  </div>

  <div class="card">
    <div class="row">
      <button id="stopBtn">עצור</button>
    </div>
    <div class="row">
      <label>קפיצה לזמן (שניות):</label>
      <input id="seekSeconds" type="number" min="0" value="60">
      <button id="seekBtn">Seek</button>
    </div>
  </div>

  <pre id="log"></pre>

<script>
async function api(path, opts={}){
  const res = await fetch(path, { ...opts });
  if(!res.ok){ const t=await res.text(); throw new Error(t||res.statusText); }
  return res.json();
}
const guildSel = document.getElementById('guilds');
const chSel    = document.getElementById('channels');
const results  = document.getElementById('results');
const logEl    = document.getElementById('log');

function log(msg){ logEl.textContent = (new Date()).toLocaleTimeString() + ' | ' + msg + '\n' + logEl.textContent; }

async function loadGuilds(){
  const r = await api('/api/guilds');
  guildSel.innerHTML = r.guilds.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
  await loadChannels();
}

async function loadChannels(){
  const gid = guildSel.value;
  if(!gid) return;
  const r = await api(`/api/guilds/${gid}/channels?type=voice`);
  chSel.innerHTML = r.channels.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

async function move(lock){
  const gid = guildSel.value, channelId = chSel.value;
  const r = await api(`/api/guilds/${gid}/move`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ channelId, lock })
  });
  log('Moved: ' + JSON.stringify(r));
}

async function unlock(){
  const gid = guildSel.value;
  const r = await api(`/api/guilds/${gid}/unlock`, { method:'POST' });
  log('Unlock: ' + JSON.stringify(r));
}

async function search(){
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  const r = await api('/api/search?q=' + encodeURIComponent(q));
  results.innerHTML = '';
  r.items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <img class="thumb" src="${it.thumbnail||''}" alt="">
      <div style="flex:1">
        <div><b>${it.title}</b></div>
        <div>${it.uploader||''} • ${it.duration||''}s</div>
      </div>
      <button>נגן</button>
    `;
    div.querySelector('button').onclick = async () => {
      const gid = guildSel.value, channelId = chSel.value;
      const r2 = await api(`/api/play`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ gid, channelId, url: it.url })
      });
      log('Play: ' + JSON.stringify(r2));
    };
    results.appendChild(div);
  });
}

async function stop(){
  const gid = guildSel.value;
  const r = await api(`/api/stop`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ gid })
  });
  log('Stop: ' + JSON.stringify(r));
}

async function seek(){
  const gid = guildSel.value;
  const seconds = Number(document.getElementById('seekSeconds').value||0);
  const r = await api(`/api/seek`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ gid, seconds })
  });
  log('Seek: ' + JSON.stringify(r));
}

document.getElementById('refreshGuilds').onclick = loadGuilds;
guildSel.onchange = loadChannels;
document.getElementById('moveBtn').onclick = ()=>move(document.getElementById('lockChk').checked);
document.getElementById('unlockBtn').onclick = unlock;
document.getElementById('searchBtn').onclick = search;
document.getElementById('stopBtn').onclick = stop;
document.getElementById('seekBtn').onclick = seek;

loadGuilds().catch(e=>log(e.message));
</script>
</body>
</html>
