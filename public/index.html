<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Music Dashboard</title>
    <style>
      body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#121212;color:#fff}
      header{padding:16px;display:flex;align-items:center;gap:12px;background:#181818;border-bottom:1px solid #2a2a2a}
      .container{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 64px)}
      aside{background:#181818;border-inline-end:1px solid #2a2a2a;padding:12px;overflow:auto}
      main{padding:16px}
      .guild{padding:8px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:8px}
      .guild:hover{background:#222}
      .row{display:flex;gap:8px;align-items:center;margin:8px 0}
      .controls button{background:#1db954;border:none;padding:8px 12px;border-radius:20px;color:#000;font-weight:bold;cursor:pointer}
      .controls button.secondary{background:#2a2a2a;color:#fff;font-weight:normal}
      input,select{background:#2a2a2a;color:#fff;border:1px solid #333;border-radius:8px;padding:8px}
      .seek{width:100%}
      footer{position:fixed;left:0;right:0;bottom:0;background:#181818;border-top:1px solid #2a2a2a;padding:8px 16px;display:flex;align-items:center;gap:12px}
      .track{flex:1}
      .time{min-width:80px;text-align:center}
    </style>
  </head>
  <body>
    <header>
      <h3>🎵 DOR Music</h3>
      <span id="status"></span>
    </header>
    <div class="container">
      <aside>
        <h4>שרתים</h4>
        <div id="guilds"></div>
      </aside>
      <main>
        <div class="row">
          <label>ערוץ קול:</label>
          <select id="voice"></select>
        </div>
        <div class="row">
          <input id="query" placeholder="שם שיר או לינק YouTube" style="flex:1"/>
          <button id="play">נגן</button>
        </div>
        <div class="controls row">
          <button id="back" class="secondary">⟲ 10s</button>
          <button id="pause" class="secondary">⏸️</button>
          <button id="resume" class="secondary">▶️</button>
          <button id="skip" class="secondary">⏭️</button>
          <button id="stop" class="secondary">⏹️</button>
          <label>עוצמה <input id="vol" type="range" min="0" max="200" value="100"/></label>
        </div>
        <div class="row">
          <div class="time" id="tcur">0:00</div>
          <input id="seek" class="seek" type="range" min="0" max="0" value="0"/>
          <div class="time" id="tmax">0:00</div>
        </div>
        <div id="now"></div>
      </main>
    </div>
    <footer>
      <div class="track" id="track">אין ניגון</div>
    </footer>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const $ = (s)=>document.querySelector(s);
      const api = (p, opt={})=>fetch(p, {headers:{'Content-Type':'application/json'}, ...opt}).then(r=>r.json());
      let gid=null, state={}, dragging=false;

      function fmt(s){ s=Math.max(0,Math.floor(s)); const m=String(Math.floor(s/60)).padStart(1,'0'); const ss=String(s%60).padStart(2,'0'); return m+':'+ss; }

      async function loadGuilds(){
        const arr = await api('/api/guilds');
        const box = $('#guilds'); box.innerHTML='';
        arr.forEach(g=>{
          const div = document.createElement('div');
          div.className='guild';
          div.textContent=g.name;
          div.onclick=()=>selectGuild(g.id);
          box.appendChild(div);
        });
        if (arr[0]) selectGuild(arr[0].id);
      }
      async function selectGuild(id){
        gid=id;
        $('#status').textContent='שרת: '+id;
        const ch = await api('/api/guilds/'+gid+'/channels');
        const voice = ch.filter(c=>c.type===2 || c.type===13); // GUILD_VOICE or STAGE
        const sel = $('#voice'); sel.innerHTML='';
        voice.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; sel.appendChild(o); });
        connectSocket();
        refreshState();
      }

      let socket=null;
      function connectSocket(){
        if (socket) socket.disconnect();
        socket = io();
        socket.on('connect', ()=>{ socket.emit('watch', gid); });
        socket.on('state', (s)=>{ state=s; render(); });
      }

      async function refreshState(){
        state = await api('/api/guilds/'+gid+'/state');
        render();
      }

      function render(){
        $('#track').textContent = state.current ? (state.current.title || 'מנגן') : 'אין ניגון';
        $('#now').textContent = state.current ? 'מנגן: '+(state.current.title||'') : '';
        $('#vol').value = Math.round((state.volume||1)*100);
        $('#seek').max = state.current?.duration || (state.position||0)+600;
        if (!dragging) $('#seek').value = state.position||0;
        $('#tcur').textContent = fmt(state.position||0);
        $('#tmax').textContent = fmt(state.current?.duration || $('#seek').max);
      }

      setInterval(()=>{
        if (state.current && !dragging){
          state.position = (state.position||0)+1;
          $('#seek').value = state.position;
          $('#tcur').textContent = fmt(state.position);
        }
      },1000);

      $('#play').onclick = async ()=>{
        const vc = $('#voice').value;
        const q = $('#query').value;
        if (!gid || !vc || !q) return;
        await api('/api/guilds/'+gid+'/play', { method:'POST', body: JSON.stringify({ voiceChannelId: vc, query: q }) });
        refreshState();
      };
      $('#pause').onclick = async ()=>{ await api('/api/guilds/'+gid+'/pause', {method:'POST'}); refreshState(); };
      $('#resume').onclick = async ()=>{ await api('/api/guilds/'+gid+'/resume', {method:'POST'}); refreshState(); };
      $('#skip').onclick = async ()=>{ await api('/api/guilds/'+gid+'/skip', {method:'POST'}); refreshState(); };
      $('#stop').onclick = async ()=>{ await api('/api/guilds/'+gid+'/stop', {method:'POST'}); refreshState(); };
      $('#back').onclick = async ()=>{ const newt = Math.max(0,(state.position||0)-10); await api('/api/guilds/'+gid+'/seek',{method:'POST', body: JSON.stringify({seconds:newt})}); refreshState(); };

      $('#vol').oninput = async (e)=>{
        const v = Number(e.target.value)/100;
        await api('/api/guilds/'+gid+'/volume',{method:'POST', body: JSON.stringify({volume: v})});
      };

      const seek = $('#seek');
      seek.addEventListener('mousedown', ()=>dragging=true);
      seek.addEventListener('touchstart', ()=>dragging=true);
      seek.addEventListener('mouseup', async ()=>{ dragging=false; const v=Number(seek.value); await api('/api/guilds/'+gid+'/seek', {method:'POST', body: JSON.stringify({seconds:v})}); });
      seek.addEventListener('touchend', async ()=>{ dragging=false; const v=Number(seek.value); await api('/api/guilds/'+gid+'/seek', {method:'POST', body: JSON.stringify({seconds:v})}); });
      seek.addEventListener('input', ()=>{ $('#tcur').textContent = fmt(Number(seek.value)); });

      loadGuilds();
    </script>
  </body>
</html>
