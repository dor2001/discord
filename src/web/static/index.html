<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DOR Discord Music</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, Arial; margin: 20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    select, input, button { padding:8px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:8px 0; }
    .results > div { cursor:pointer; padding:6px; border-bottom:1px solid #eee }
    .results > div:hover { background:#f6f6f6 }
    .muted { color:#777 }
  </style>
</head>
<body>
  <h2>Login</h2>
  <div class="row">
    <input id="u" placeholder="username" value="admin" />
    <input id="p" placeholder="password" value="admin123" type="password" />
    <button onclick="login()">Login</button>
  </div>

  <div id="app" style="display:none">
    <h2>Control Panel</h2>
    <div class="row">
      <label>Guild:</label>
      <select id="guilds" onchange="loadChannels()"></select>
      <label>Channel:</label>
      <select id="channels"></select>
      <button onclick="move()">Move Bot</button>
      <button onclick="lock()">Lock</button>
    </div>

    <div class="card">
      <h3>Search</h3>
      <div class="row">
        <input id="q" placeholder="Search YouTube mirror..." style="min-width:300px" />
        <button onclick="search()">Search</button>
      </div>
      <div id="results" class="results"></div>
    </div>

    <div class="card">
      <h3>Now Playing</h3>
      <div id="now" class="muted">—</div>
      <div class="row">
        <input id="seek" type="number" value="0" min="0" step="1" />
        <button onclick="seek()">Seek (sec)</button>
        <button onclick="pause()">Pause</button>
        <button onclick="resume()">Resume</button>
        <button onclick="skip()">Skip</button>
        <button onclick="stop()">Stop</button>
      </div>
    </div>
  </div>

<script>
async function req(path, opts={}){
  const r = await fetch(path, { headers:{'Content-Type':'application/json'}, credentials:'same-origin', ...opts });
  if (!r.ok) {
    let e = await r.json().catch(()=>({error:r.statusText}));
    throw new Error(e.error||'Request failed');
  }
  return r.json();
}

async function login(){
  await req('/api/login', { method:'POST', body: JSON.stringify({ username: document.getElementById('u').value, password: document.getElementById('p').value }) });
  document.getElementById('app').style.display='block';
  await loadGuilds();
}

async function loadGuilds(){
  const g = await req('/api/guilds');
  const sel = document.getElementById('guilds');
  sel.innerHTML = g.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  await loadChannels();
  refreshNow();
}

async function loadChannels(){
  const gid = document.getElementById('guilds').value;
  if (!gid) return;
  const cs = await req('/api/channels?guildId='+gid);
  const sel = document.getElementById('channels');
  sel.innerHTML = cs.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
}

async function move(){
  const gid = document.getElementById('guilds').value;
  const cid = document.getElementById('channels').value;
  await req('/api/move', { method:'POST', body: JSON.stringify({ guildId: gid, channelId: cid }) });
}

async function lock(){
  const gid = document.getElementById('guilds').value;
  const cid = document.getElementById('channels').value;
  await req('/api/lock', { method:'POST', body: JSON.stringify({ guildId: gid, channelId: cid }) });
}

async function search(){
  const q = document.getElementById('q').value;
  const r = await req('/api/search?q='+encodeURIComponent(q));
  const el = document.getElementById('results');
  el.innerHTML = r.map(v=>`<div onclick="play('${v.videoId}')">${v.title} <span class='muted'>(${v.duration||'?' }s)</span></div>`).join('');
}

async function play(videoId){
  const gid = document.getElementById('guilds').value;
  const cid = document.getElementById('channels').value;
  await req('/api/play', { method:'POST', body: JSON.stringify({ guildId: gid, channelId: cid, videoId }) });
  refreshNow();
}

async function seek(){
  const gid = document.getElementById('guilds').value;
  const s = Number(document.getElementById('seek').value || 0);
  await req('/api/seek', { method:'POST', body: JSON.stringify({ guildId: gid, seconds: s }) });
  refreshNow();
}
async function pause(){ const gid=document.getElementById('guilds').value; await req('/api/pause',{method:'POST',body:JSON.stringify({guildId:gid})}); }
async function resume(){ const gid=document.getElementById('guilds').value; await req('/api/resume',{method:'POST',body:JSON.stringify({guildId:gid})}); }
async function skip(){ const gid=document.getElementById('guilds').value; await req('/api/skip',{method:'POST',body:JSON.stringify({guildId:gid})}); refreshNow(); }
async function stop(){ const gid=document.getElementById('guilds').value; await req('/api/stop',{method:'POST',body:JSON.stringify({guildId:gid})}); refreshNow(); }

async function refreshNow(){
  const gid = document.getElementById('guilds').value;
  const st = await req('/api/state?guildId='+gid);
  const now = st.current ? `${st.current.title} — ${Math.round(st.current.position||0)} / ${st.current.duration||'?'} sec` : '—';
  document.getElementById('now').innerText = now;
  setTimeout(refreshNow, 2000);
}
</script>
</body>
</html>
